name: Test SSH Connection

on:
  workflow_dispatch:  # 手動実行のみ（SSH接続テスト用）

jobs:
  test-connection:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # SSH秘密鍵の設定
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "ERROR: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          
          # 秘密鍵をファイルに書き込む（改行を保持）
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # 秘密鍵の形式を検証
          echo "Validating SSH key format..."
          if ! ssh-keygen -l -f ~/.ssh/id_rsa > /dev/null 2>&1; then
            echo "❌ ERROR: Invalid SSH private key format!"
            echo ""
            echo "The SSH_PRIVATE_KEY secret appears to be invalid."
            echo "Please check:"
            echo "  1. The key includes the header: -----BEGIN OPENSSH PRIVATE KEY-----"
            echo "  2. The key includes the footer: -----END OPENSSH PRIVATE KEY-----"
            echo "  3. All lines are properly formatted (no extra spaces or characters)"
            echo "  4. The key is complete (not truncated)"
            echo ""
            echo "First 50 characters of the key:"
            head -c 50 ~/.ssh/id_rsa
            echo ""
            echo "Last 50 characters of the key:"
            tail -c 50 ~/.ssh/id_rsa
            echo ""
            exit 1
          fi
          
          echo "✓ SSH key file created and validated"
          
          # サーバー情報の確認
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "ERROR: SERVER_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "ERROR: SERVER_USER secret is not set"
            exit 1
          fi
          
          echo "Server: ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_PORT || 22 }}"
          
          # ホストキーの取得
          echo "Scanning host keys..."
          ssh-keyscan -H -p ${{ secrets.SERVER_PORT || 22 }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>&1 || {
            echo "Warning: ssh-keyscan failed, but continuing..."
          }
          echo "✓ SSH setup completed"

      - name: Test SSH Connection
        run: |
          set +e  # エラーでも続行して詳細情報を取得
          echo "=========================================="
          echo "Testing SSH connection..."
          echo "=========================================="
          
          SSH_CMD="ssh -p ${{ secrets.SERVER_PORT || 22 }} \
            -o StrictHostKeyChecking=yes \
            -o ConnectTimeout=30 \
            -o ServerAliveInterval=10 \
            -o ServerAliveCountMax=3 \
            -o BatchMode=yes \
            -o LogLevel=DEBUG3 \
            -vvv"
          
          echo "Connection details:"
          echo "  Host: ${{ secrets.SERVER_HOST }}"
          echo "  Port: ${{ secrets.SERVER_PORT || 22 }}"
          echo "  User: ${{ secrets.SERVER_USER }}"
          echo ""
          
          # まず簡単なコマンドでテスト（詳細ログ付き）
          echo "Step 1: Testing basic connection with verbose logging..."
          $SSH_CMD ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo '✓ Basic connection successful!'" 2>&1 | tee /tmp/ssh_output.log
          SSH_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $SSH_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "❌ Basic SSH connection failed with exit code: $SSH_EXIT_CODE"
            echo ""
            echo "=== Possible causes ==="
            echo "1. Server is closing connection after authentication"
            echo "2. Server SSH config may restrict connections"
            echo "3. Server may have IP-based restrictions"
            echo "4. Server may require specific SSH options"
            echo ""
            echo "=== Server-side checks needed ==="
            echo "Please check server SSH config (/etc/ssh/sshd_config):"
            echo "  - MaxSessions, MaxStartups settings"
            echo "  - AllowUsers, DenyUsers settings"
            echo "  - ClientAliveInterval, ClientAliveCountMax"
            echo "  - Match blocks that might restrict connections"
            echo ""
            echo "=== Trying alternative connection method ==="
            
            # 別の方法で試す: 対話的でないシンプルな接続
            echo "Trying simple SSH connection..."
            ssh -p ${{ secrets.SERVER_PORT || 22 }} \
              -o StrictHostKeyChecking=yes \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              -o PreferredAuthentications=publickey \
              -T ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "true" 2>&1 || {
              echo "Simple SSH connection also failed"
            }
            
            echo ""
            echo "=== Testing rsync connection (used in deploy) ==="
            # rsync経由で接続を試す（デプロイで使用する方法）
            echo "test" > /tmp/test_file.txt
            rsync -avz --dry-run \
              -e "ssh -p ${{ secrets.SERVER_PORT || 22 }} -o StrictHostKeyChecking=yes -o BatchMode=yes" \
              /tmp/test_file.txt ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/ 2>&1 || {
              echo "rsync connection also failed"
            }
            rm -f /tmp/test_file.txt
            
            echo ""
            echo "=== Testing SFTP connection ==="
            # SFTP経由で接続を試す
            echo "test" > /tmp/test_sftp.txt
            printf 'ls\npwd\nquit\n' > /tmp/sftp_commands.txt
            sftp -P ${{ secrets.SERVER_PORT || 22 }} \
              -o StrictHostKeyChecking=yes \
              -o BatchMode=yes \
              -b /tmp/sftp_commands.txt \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 2>&1 && {
              echo "✓ SFTP connection successful!"
            } || {
              echo "✗ SFTP connection failed"
            }
            rm -f /tmp/test_sftp.txt /tmp/sftp_commands.txt
            
            echo ""
            echo "=== Testing SCP connection ==="
            # SCP経由で接続を試す
            echo "test" > /tmp/test_scp.txt
            scp -P ${{ secrets.SERVER_PORT || 22 }} \
              -o StrictHostKeyChecking=yes \
              -o BatchMode=yes \
              /tmp/test_scp.txt ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/test_scp_remote.txt 2>&1 && {
              echo "✓ SCP connection successful!"
            } || {
              echo "✗ SCP connection failed"
            }
            rm -f /tmp/test_scp.txt
            
            echo ""
            echo "=== Summary ==="
            echo "All connection methods failed. This suggests:"
            echo "1. Server SSH config is restricting non-interactive connections"
            echo "2. Server may require specific SSH options or environment"
            echo "3. Server security software may be blocking automated connections"
            echo ""
            echo "=== Next steps ==="
            echo "1. Check server SSH logs: /var/log/auth.log or /var/log/secure"
            echo "2. Review server SSH config: /etc/ssh/sshd_config"
            echo "3. Check for Match blocks or ForceCommand settings"
            echo "4. Verify the user's shell is not restricted"
            echo "5. Check if the server allows rsync/SCP connections"
            
            exit 1
          fi
          
          set -e  # 以降はエラーで停止
          echo ""
          echo "✓ Basic connection successful! Proceeding with further tests..."
          echo ""
          
          # 詳細ログを減らして通常のコマンドを実行
          SSH_CMD_NORMAL="ssh -p ${{ secrets.SERVER_PORT || 22 }} \
            -o StrictHostKeyChecking=yes \
            -o ConnectTimeout=30 \
            -o ServerAliveInterval=10 \
            -o ServerAliveCountMax=3 \
            -o BatchMode=yes"
          
          echo "Step 2: Getting server info..."
          $SSH_CMD_NORMAL ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "echo 'Server info:' && \
             uname -a && \
             echo 'Current directory:' && \
             pwd"
          
          echo ""
          echo "Step 3: Testing remote path: ${{ secrets.REMOTE_PATH }}"
          $SSH_CMD_NORMAL ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "if [ -d '${{ secrets.REMOTE_PATH }}' ]; then
               echo '✓ Remote path exists'
               ls -la '${{ secrets.REMOTE_PATH }}' | head -5
             else
               echo '⚠ Remote path does not exist'
               echo 'Parent directory:'
               ls -la \$(dirname '${{ secrets.REMOTE_PATH }}') | head -5
             fi" || {
            echo "⚠ Remote path check failed, but connection is working"
          }
          
          echo ""
          echo "✅ All connection tests passed!"

      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa

