name: Test SSH Connection

on:
  workflow_dispatch:  # 手動実行のみ

jobs:
  test-connection:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # SSH秘密鍵の設定
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "ERROR: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          
          # 秘密鍵をファイルに書き込む（改行を保持）
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # 秘密鍵の形式を検証
          echo "Validating SSH key format..."
          if ! ssh-keygen -l -f ~/.ssh/id_rsa > /dev/null 2>&1; then
            echo "❌ ERROR: Invalid SSH private key format!"
            echo ""
            echo "The SSH_PRIVATE_KEY secret appears to be invalid."
            echo "Please check:"
            echo "  1. The key includes the header: -----BEGIN OPENSSH PRIVATE KEY-----"
            echo "  2. The key includes the footer: -----END OPENSSH PRIVATE KEY-----"
            echo "  3. All lines are properly formatted (no extra spaces or characters)"
            echo "  4. The key is complete (not truncated)"
            echo ""
            echo "First 50 characters of the key:"
            head -c 50 ~/.ssh/id_rsa
            echo ""
            echo "Last 50 characters of the key:"
            tail -c 50 ~/.ssh/id_rsa
            echo ""
            exit 1
          fi
          
          echo "✓ SSH key file created and validated"
          
          # サーバー情報の確認
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "ERROR: SERVER_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "ERROR: SERVER_USER secret is not set"
            exit 1
          fi
          
          echo "Server: ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_PORT || 22 }}"
          
          # ホストキーの取得
          echo "Scanning host keys..."
          ssh-keyscan -H -p ${{ secrets.SERVER_PORT || 22 }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>&1 || {
            echo "Warning: ssh-keyscan failed, but continuing..."
          }
          echo "✓ SSH setup completed"

      - name: Test SSH Connection
        run: |
          set -e
          echo "=========================================="
          echo "Testing SSH connection..."
          echo "=========================================="
          
          SSH_CMD="ssh -p ${{ secrets.SERVER_PORT || 22 }} \
            -o StrictHostKeyChecking=yes \
            -o ConnectTimeout=30 \
            -o ServerAliveInterval=60 \
            -o ServerAliveCountMax=3 \
            -o BatchMode=yes \
            -o LogLevel=INFO"
          
          echo "Connection details:"
          echo "  Host: ${{ secrets.SERVER_HOST }}"
          echo "  Port: ${{ secrets.SERVER_PORT || 22 }}"
          echo "  User: ${{ secrets.SERVER_USER }}"
          echo ""
          
          # まず簡単なコマンドでテスト
          echo "Step 1: Testing basic connection..."
          $SSH_CMD ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo '✓ Basic connection successful!'" || {
            echo "❌ Basic SSH connection failed!"
            exit 1
          }
          
          echo ""
          echo "Step 2: Getting server info..."
          $SSH_CMD ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "echo 'Server info:' && \
             uname -a && \
             echo 'Current directory:' && \
             pwd" || {
            echo "❌ Command execution failed!"
            exit 1
          }
          
          echo ""
          echo "Step 3: Testing remote path: ${{ secrets.REMOTE_PATH }}"
          $SSH_CMD ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "if [ -d '${{ secrets.REMOTE_PATH }}' ]; then
               echo '✓ Remote path exists'
               ls -la '${{ secrets.REMOTE_PATH }}' | head -5
             else
               echo '⚠ Remote path does not exist'
               echo 'Parent directory:'
               ls -la \$(dirname '${{ secrets.REMOTE_PATH }}') | head -5
             fi" || {
            echo "⚠ Remote path check failed, but connection is working"
          }
          
          echo ""
          echo "✅ All connection tests passed!"

      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa

